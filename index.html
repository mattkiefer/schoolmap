<!DOCTYPE html>
<meta charset="utf-8">
<style></style>
<body>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>


/*
*
* presentation metadata (e.g. map color schemes) for each dataset
*
*/

var data_configs = {
                    /*
                    'example': {
                                'properties'    : {string} key to look up json data 
                                'button_name'   : {string} how to present the toggle switch
                                'domain_type'   : {string} ordinal or quantize
                                'scale_range'   : {array} the range of values (ordinal: array, quantize: min/max)
                                'color_palette' : {array} from colorbrewer 
                               }
                    ,
                    */
                    'default':       {
                                      'properties'    : 'default',
                                      'data_type'     : null,
                                      'button_name'   : null,
                                      'domain_type'   : null,
                                      'scale_range'   : null,
                                      'color_palette' : null,
                                      'chatter'       : null,
                                     },
                    'race'   :       {
                                      'properties'    : 'racial_majority',
                                      'data_type'     : null,
                                      'button_name'   : 'Race',
                                      'domain_type'   : 'ordinal',
                                      'scale_range'   : ['Black','White','Hispanic','Mixed'],
                                      'color_palette' : ['#a6cee3','#1f78b4', '#b2df8a', '#33a02c'],
                                      'chatter'       : 'kjasbdasdnasdjkln'
                                     },
                    'hs'     :       {
                                      'properties'    : 'hs_diploma_or_less',
                                      'data_type'     : 'pct',
                                      'button_name'   : 'No college',
                                      'domain_type'   : 'quantize',
                                      'scale_range'   : null, // min/max
                                      'color_palette' : ["rgb(237,248,233)", "rgb(186,228,179)","rgb(116,196,118)", "rgb(49,163,84)","rgb(0,109,44)"],
                                      'chatter'       : 'dthueruywerhwvwqevwqevqfv',
                                     },
                    'unemployment' : {
                                      'properties'    : 'unemployment',
                                      'data_type'     : 'pct',
                                      'button_name'   : 'Unemployment',
                                      'domain_type'   : 'quantize',
                                      'scale_range'   : null, // min/max
                                      'color_palette' : ["rgb(237,248,233)", "rgb(186,228,179)","rgb(116,196,118)", "rgb(49,163,84)","rgb(0,109,44)"],
                                      'chatter'       : 'vqwqvfqvqwvqvqvqwvqwvqwf',
                                     },
                    'vacancy'      : {
                                      'properties'    : 'vacancy',
                                      'data_type'     : 'pct',
                                      'button_name'   : 'Vacancy',
                                      'domain_type'   : 'quantize',
                                      'scale_range'   : null, // min/max
                                      'color_palette' : ["rgb(237,248,233)", "rgb(186,228,179)","rgb(116,196,118)", "rgb(49,163,84)","rgb(0,109,44)"],
                                      'chatter'       : 'skdjghadkjfnakjdnakscj askcj a',
                                     },
                    'poverty'      : {
                                      'properties'    : 'poverty',
                                      'data_type'     : 'pct',
                                      'button_name'   : 'Poverty',
                                      'domain_type'   : 'quantize',
                                      'scale_range'   : null, // min/max
                                      'color_palette' : ["rgb(237,248,233)", "rgb(186,228,179)","rgb(116,196,118)", "rgb(49,163,84)","rgb(0,109,44)"],
                                      'chatter'       : 'asc89i933hnr',
                                     },
                    'property'     : {
                                      'properties'    : 'property',
                                      'data_type'     : null,
                                      'button_name'   : 'Property crime',
                                      'domain_type'   : 'quantize',
                                      'scale_range'   : null, // min/max
                                      'color_palette' : ["rgb(237,248,233)", "rgb(186,228,179)","rgb(116,196,118)", "rgb(49,163,84)","rgb(0,109,44)"],
                                      'chatter'       : '8u9898h98uwsghsrgohs',
                                     },
                    'violent'      : {
                                      'properties'    : 'violent',
                                      'data_type'     : null,
                                      'button_name'   : 'Violent crime',
                                      'domain_type'   : 'quantize',
                                      'scale_range'   : null, // min/max
                                      'color_palette' : ["rgb(237,248,233)", "rgb(186,228,179)","rgb(116,196,118)", "rgb(49,163,84)","rgb(0,109,44)"],
                                      'chatter'       : 'asfasfafafglihuoihoh',
                                     }
}


/*
*
* drawing map on svg
*
*/

var width = 960
    height = 700

var svg = d3.select("body").append("svg")
.attr({
       width  : width,
       height : height,
     })    

var projection = d3.geo.mercator()
    .center([-87.7, 41.9 ])
    .scale([width * 80])

var path = d3.geo.path().projection(projection)

var default_color = '#CCCCCC'

var map = d3.json("viz_data/data.geojson", function(json) {
    // get data and shapes
    comm_areas = json.features
  
    // TODO: figure out how to handle default configs 
    config = null
    
    // default map
    svg.selectAll("path")
    .data(comm_areas)
    .enter()
    .append("path")
    //.attr("d",path) //comment out this line to speed up processing for testing
    .attr("class","cas")
    .attr("fill", default_color)
 
    
    // load switches and click events from var data_configs
    for (config_name in data_configs) {
        if (config_name != 'default') {
            var this_config = data_configs[config_name]
            button_name = this_config['button_name']
            // instantiate the toggle switches
            d3.select("body").append("p").attr("id",config_name).html(button_name)
            // add onclicks, set global config
            //.on("click", swap_chatter(this_config))
            .on("click",function() { 
                config = data_configs[this.id]
                // handle ordinal (text) vs quantize (numerical) choropleths 
                if (! config) {
                    // but first check if we have a dataset selected
                    // ... and if not, pass
                } else {
                    if (config['domain_type'] == 'ordinal') {
                        type = 'ordinal'
                        color = d3.scale.ordinal()
                        color.domain([config['scale_range']])
                    } else {
                        try {
                            type = 'quantize'
                            color = d3.scale.quantize()
                            min = d3.min(comm_areas, function(ca) {return ca.properties[config.properties]})
                            max = d3.max(comm_areas, function(ca) {return ca.properties[config.properties]})
                            config['scale_range'] = ([min,max])
                        } catch(err) {
                            console.log(err)
                        }
                    }
                color.domain(config['scale_range'])
                // add colors
                color.range(config['color_palette'])
                svg.selectAll(".cas").attr("fill", function(d) {  return color(d.properties[config.properties]) })
                //make_legend(color,config,type)
                make_legend_d3(color,config,type)
                //swap chatter
                d3.select("#fo_chatter_div").text(config['chatter'])
                }
            })
            //.on("click",function(){d3.select("#chatter").text("bar")})
        }
    }    


    /*
    *
    * put the schools on 
    *
    */
    var schools = d3.csv("viz_data/geo_schools.csv", function(csv) {
        svg.selectAll("circle")
        .data(csv)
        .enter()
        .append("circle")
        .attr("cx", function(d) {return projection([d.lon,d.lat])[0]}) 
        .attr("cy", function(d) {return projection([d.lon,d.lat])[1]})
        .attr("r", "5px")
        .attr("class","schools")
        .attr("fill", function(d) { return school_fill(d['Repurposed?'])}) // TODO: fill color based on repurpose
        }
    )

})

var school_fill = function(repurpose) {
//
    if (repurpose == 'yes') {
        return "blue"} 
    else {
        return "gray"}
}




/*
*
* make a map legend
*
*/ 

var legend_coordinates = { 'x': 100, 'y': 400 }
var legend_element     = d3.select("svg").append("g")
legend_element.attr({
                    id : "legend",
                    x  : legend_coordinates['x'],
                    y  : legend_coordinates['y'],
                   })

var percentify = function(tuple) {
    min          = Math.round(tuple[0]*100)
    max          = Math.round(tuple[1]*100)
    range_string = min + "% - " + max + "%" 
    return range_string
}


var make_legend_d3 = function(color,config,type){
    //bind_labels_to_colors(config.scale_range)
    d3.selectAll(".legend_label").remove()
    d3.selectAll(".legend_square").remove()

    // set up name, color palette, labels, position    
    var name           = config['button_name']
    var palette        = config['color_palette']
    var labels         = config['scale_range']
    var x_coord        = legend_coordinates['x']
    var y_coord        = legend_coordinates['y']
    var box_dimensions = { 'height': 10, 'width': 10 }

    // build data: {'color':'value_range'}
    var data = []
    for (i=0;i<palette.length;i++){
        datum            = {}
        datum['shade']   = palette[i]
        if (type == 'ordinal'){
            // labels are predefined text so go get them
            var range = labels[i]
        } else {
            // labels are derived by quantized intervals
            var range = color.invertExtent(datum['shade'])
            if (config['data_type'] == 'pct') { range = percentify(range) } 
        }
        datum['range']   = range
        datum['y']       = y_coord
        y_coord          = y_coord + 20
        var height       = box_dimensions['height']
        var width        = box_dimensions['width']  
        data.push(datum)
    }

    // do some d3
    var squares = legend_element.selectAll("rect")
        .data(data)
        .enter()
        .append("rect")

    var square_attributes = squares.attr({
        class  : 'legend_label',
        y      : function(d) { return d.y},
        x      : x_coord,
        fill   : function(d) { return d.shade},
        height : height,
        width  : width,
    })

    var labels = legend_element.selectAll("text")
        .data(data)
        .enter()
        .append("text")

    var label_attributes = labels.attr({
        class       : 'legend_label',
        y           : function(d) { return d.y + height},
        x           : x_coord + 20,
        'font-size' : '10px'
    })

    var labels_text = labels.text(function(d){return d.range})

}


var chatter_box = d3.select("svg")
                    .append("g")
                    .attr({
                           id     : "chatterbox",
                           height : 200,
                           width  : 200,
                         })

var chatter = d3.select("#chatterbox")
                .append("text")
                .text(" sdas")
                /*.attr({
                       id:'chatter',
                       x:150,
                       y:200
                     })
                */
var fo = d3.select("#chatterbox")
           .append("foreignObject")
           .attr({
                  id:'fo_chatter',
                   x:250,
                   y:200
                 })

var div = fo.append('xhtml:div')
            .text("askdhasnkdjn  a ksdbakjdbh as asd as f  s h sd h wdsh s hs dhs dh s hshshs")
            .attr({
                   id   : "fo_chatter_div",
                   width: 100
                 })


/*
var chatter_group = d3.select("svg")
                      .append("g")
                      .attr({
                             id : "chatterbox",
                             x  : 100,
                             y  : 600,
                           })


var chatter_box = d3.select("#chatterbox")
                    .append("text")
                    .attr({
                           id  : "chatter",
                         })

var swap_chatter = function(chatter) {
    d3.select('#chatterbox').append("text").text(chatter) 
}
*/

</script>
